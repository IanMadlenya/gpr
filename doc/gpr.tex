\documentclass[12pt]{article}

\usepackage[usenames]{color}

\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsbsy}
\usepackage{accents}

\DeclareMathAlphabet{\mathsfsl}{OT1}{cmss}{m}{sl}

\newcommand{\red}{\textcolor{red}}

\newcommand{\dif}{\mathrm{d}}

\newcommand{\myu}[1]{\underaccent{\bar}{#1}}

\newcommand{\onehalf}{\tfrac{1}{2}}

\newcommand{\mat}[1]{\mbox{$\mathsfsl{#1}$}}
\newcommand{\myvec}[1]{\mbox{\boldmath$#1$}}

\newcommand{\diagv}[1]{\mathrm{diag_v}(#1)}
\newcommand{\diagm}[1]{\mathrm{diag_m}(#1)}
\newcommand{\trace}[1]{\mathrm{tr}(#1)}
\newcommand{\transv}[1]{\myvec{#1}^\top}
\newcommand{\transm}[1]{\mat{#1}^\top}

\newcommand{\imat}[1]{\mat{#1^{-1}}}
\newcommand{\ichol}[1]{\mat{#1^{-\onehalf}}}
\newcommand{\icholt}[1]{\mat{#1^{-\tfrac{\top}{2}}}}

\newcommand{\Km}{\mat{K_M}}
\newcommand{\iKm}{\imat{K_M}}
\newcommand{\dKm}{\mat{\dot{K}_M}}
\newcommand{\dkn}{\mat{\dot{K}_N}}
\newcommand{\Kmn}{\mat{K_{MN}}}
\newcommand{\Knm}{\transm{K_{MN}}}
\newcommand{\uKnm}{\myu{\mat{K}}_{\mathsfsl{MN}}^\top}
\newcommand{\uuKnm}{\myu{\myu{\mat{K}}}_{\mathsfsl{MN}}^\top}
\newcommand{\dKmn}{\mat{\dot{K}_{MN}}}
\newcommand{\uKmn}{\myu{\mat{K}}_{\mathsfsl{MN}}}
\newcommand{\uuKmn}{\myu{\myu{\mat{K}}}_{\mathsfsl{MN}}}

\newcommand{\dl}{\dot{l}}

\newcommand{\vecr}{\myvec{r}}
\newcommand{\vecs}{\myvec{s}}
\newcommand{\vect}{\myvec{t}}
\newcommand{\vecv}{\myvec{v}}
\newcommand{\vecu}{\myvec{u}}
\newcommand{\vecw}{\myvec{w}}
\newcommand{\vecy}{\myvec{y}}
\newcommand{\uuvecy}{\myu{\myu{\vecy}}}

\newcommand{\vecsdh}{\onehalf\myvec{\dot{s}}}
\newcommand{\vecis}{\myvec{s}^{-1}}
\newcommand{\veciss}{\myvec{s}^{-\onehalf}}

\newcommand{\matB}{\mat{B}}
\newcommand{\matI}{\mat{I}}
\newcommand{\matS}{\mat{S}}
\newcommand{\matT}{\mat{T}}
\newcommand{\matU}{\mat{U}}
\newcommand{\matV}{\mat{V}}
\newcommand{\matW}{\mat{W}}

\newcommand{\Lam}{\mat{\Lambda}}
\newcommand{\Lamss}{\mat{\Lambda}_{\sigma^2}}
\newcommand{\Lamssi}{\imat{\Lambda_{\sigma^2}}}

\begin{document}

\section{FIC computations}

These are computations of the FIC-likelihood as used in the
OCaml-implementation.  The implementation factorizes the computations
in exactly that way to minimize computation time.  Numerical stability
may still need to be improved.

\begin{itemize}
\item $\mathrm{diag_m}$ is the matrix consisting of only the diagonal
\end{itemize}

Note: $\tfrac{\partial f}{\partial \log(x)} = \tfrac{\partial f}{\partial x} x$

\begin{eqnarray*}
\matV & = & \ichol{K_M}\Kmn \\
\mat{Q_N} & = & \transm{V} \matV \\
\Lam & = & \diagm{\mat{K_N} - \mat{Q_N}} \\
\Lamss & = & \Lam + \sigma^2 \matI \\
\uKmn & = & \Kmn \ichol{\Lamss} \\
\uuKmn & = & \uKmn\ichol{\Lamss} \\
\matB & = & \Km + \uKmn\uKnm \\
\matS & = & \imat{K_M} - \imat{B} \\
\matT & = & \ichol{B}\uuKmn \\
\matU & = & \icholt{B}\matT \\
\matW & = & \icholt{K_M}\mat{V} \\
\vecr & = & \diagv{\Lam} \\
\vecs & = & \diagv{\Lamss} \\
\vecis & = & \diagv{\Lamssi} \\
\vecsdh & = & \onehalf\diagv{\dkn} + \transm{W}(\onehalf\dKm W - \dKmn) \\
\vect & = & \matU \vecy \\
\vecu & = & (\Knm \vect - \vecy) \otimes \vecis \\
\mu_* & = & \mat{K_{*M}} \vect \\
\sigma^2_* & = & K_* - \mat{K_{*M}}\matS\mat{K_{M*}} + \sigma^2 \matI \\
l_1 & = & \onehalf (\log|\Km| - \log|\matB| - \log|\Lamss| - N \log 2\pi \red{\, - \, \vecis \cdot \vecr}) \\
l_2 & = & \onehalf \vecu\cdot\vecy \\
l & = & l_1 + l_2 \\
\vecv & = & \diagv{\transm{T}\matT} - \vecis \red{\, - \, \vecis + \vecis\otimes(\vecis \otimes \vecr)} \\
\vecw & = & \vecu \otimes \vecu \\
\dl_1 & = & \vecsdh\cdot\vecv + \onehalf\trace{\matS\dKm} - \trace{\transm{U}\dKmn} \\
\tfrac{\dif l_1}{\sigma^2} & = & \onehalf (\mathrm{sum}(\vecv) \red {\, + \, \mathrm{sum}(\vecis)}) \\
\dl_2 & = & \vecsdh\cdot\vecw - \vect\cdot(\dKm \onehalf \vect + \dKmn \vecu) \\
\tfrac{\dif l_2}{\sigma^2} & = & \onehalf \mathrm{sum}(\vecw) \\
\dl & = & \dl_1 + \dl_2 \\
\end{eqnarray*}

\end{document}
